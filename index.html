<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‚ö° DEADLINE DELIVERY ‚ö° - Arcade Racing Chaos</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        html, body {
            width: 100%;
            height: 100%;
            overflow: hidden;
            background: #000;
            font-family: 'Arial Black', Arial, sans-serif;
            color: #fff;
        }

        /* MAIN MENU */
        #mainMenu {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #1a0000 0%, #330000 50%, #1a0000 100%);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 10000;
            flex-direction: column;
        }

        .menu-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: radial-gradient(circle at 50% 50%, rgba(255, 51, 51, 0.3) 0%, rgba(0, 0, 0, 0.9) 100%);
            z-index: 1;
        }

        .menu-content {
            position: relative;
            z-index: 2;
            text-align: center;
            animation: menuFadeIn 1s ease-out;
        }

        @keyframes menuFadeIn {
            from {
                opacity: 0;
                transform: scale(0.8);
            }
            to {
                opacity: 1;
                transform: scale(1);
            }
        }

        .menu-content h1 {
            font-size: 120px;
            font-weight: 900;
            color: #ff3333;
            text-shadow: 0 0 50px #ff0000, 0 0 100px #cc0000, 0 0 150px #990000;
            margin-bottom: 10px;
            letter-spacing: 5px;
            animation: titlePulse 1.5s infinite;
        }

        @keyframes titlePulse {
            0%, 100% {
                text-shadow: 0 0 50px #ff3333, 0 0 100px #ff0000, 0 0 150px #cc0000;
            }
            50% {
                text-shadow: 0 0 100px #ff3333, 0 0 150px #ff5555, 0 0 200px #ff0000;
            }
        }

        .menu-content h2 {
            font-size: 32px;
            color: #ffff00;
            text-shadow: 0 0 20px #ffff00;
            margin-bottom: 20px;
            letter-spacing: 2px;
        }

        .menu-content p {
            font-size: 18px;
            color: #aaa;
            margin-bottom: 40px;
            line-height: 1.8;
            max-width: 800px;
        }

        .menu-buttons {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            justify-content: center;
            margin-bottom: 30px;
        }

        .menu-btn {
            padding: 20px 40px;
            font-size: 18px;
            font-weight: bold;
            border: 3px solid #ff3333;
            background: rgba(255, 51, 51, 0.2);
            color: #ff3333;
            cursor: pointer;
            border-radius: 10px;
            transition: all 0.3s;
            text-transform: uppercase;
            letter-spacing: 2px;
            box-shadow: 0 0 20px rgba(255, 51, 51, 0.5);
        }

        .menu-btn:hover {
            background: rgba(255, 51, 51, 0.5);
            box-shadow: 0 0 40px rgba(255, 51, 51, 0.8);
            transform: scale(1.1);
        }

        .menu-btn:active {
            transform: scale(0.95);
        }

        .menu-btn.secondary {
            border-color: #00ff00;
            color: #00ff00;
            background: rgba(0, 255, 0, 0.1);
            box-shadow: 0 0 20px rgba(0, 255, 0, 0.5);
        }

        .menu-btn.secondary:hover {
            background: rgba(0, 255, 0, 0.3);
            box-shadow: 0 0 40px rgba(0, 255, 0, 0.8);
        }

        /* SCREENS */
        .screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: none;
            z-index: 9999;
        }

        .screen.active {
            display: flex;
        }

        #carSelectScreen, #mapSelectScreen {
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }

        .select-title {
            font-size: 48px;
            color: #00ff00;
            text-shadow: 0 0 30px #00ff00;
            margin-bottom: 30px;
            letter-spacing: 3px;
        }

        .grid-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 15px;
            padding: 20px;
            max-width: 1200px;
            margin-bottom: 30px;
        }

        .card {
            padding: 20px;
            background: rgba(51, 51, 51, 0.7);
            border: 2px solid #555;
            border-radius: 10px;
            cursor: pointer;
            text-align: center;
            transition: all 0.3s;
            color: #aaa;
            font-weight: bold;
        }

        .card:hover {
            border-color: #00ff00;
            background: rgba(0, 255, 0, 0.1);
            transform: scale(1.05);
        }

        .card.selected {
            border-color: #00ff00;
            background: rgba(0, 255, 0, 0.3);
            color: #00ff00;
            box-shadow: 0 0 20px rgba(0, 255, 0, 0.6);
        }

        .card.locked {
            opacity: 0.4;
            cursor: not-allowed;
            border-color: #666;
        }

        /* HUD */
        #gameHUD {
            position: fixed;
            top: 10px;
            left: 10px;
            background: rgba(0, 0, 0, 0.9);
            padding: 20px;
            border: 3px solid #ff3333;
            border-radius: 10px;
            z-index: 100;
            min-width: 350px;
            font-size: 14px;
            font-weight: bold;
            display: none;
        }

        .hud-row {
            display: flex;
            justify-content: space-between;
            margin: 8px 0;
            padding: 5px 0;
            border-bottom: 1px solid rgba(255, 51, 51, 0.3);
        }

        .hud-label {
            color: #ff3333;
            min-width: 150px;
        }

        .hud-value {
            color: #ffff00;
            font-size: 16px;
        }

        /* TIMER BAR */
        #timerContainer {
            position: fixed;
            top: 140px;
            left: 10px;
            width: 350px;
            height: 50px;
            background: rgba(0, 0, 0, 0.9);
            border: 3px solid #ff3333;
            border-radius: 10px;
            overflow: hidden;
            z-index: 100;
            display: none;
        }

        #timerBar {
            height: 100%;
            width: 100%;
            background: linear-gradient(90deg, #00ff00, #ffff00, #ff3333);
            transition: width 0.05s linear;
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        #timerText {
            position: absolute;
            width: 100%;
            text-align: center;
            color: #000;
            font-weight: 900;
            font-size: 20px;
            z-index: 2;
            text-shadow: 1px 1px 2px #fff;
        }

        /* SPEEDOMETER */
        #speedometer {
            position: fixed;
            bottom: 30px;
            right: 30px;
            font-size: 32px;
            font-weight: 900;
            color: #ffff00;
            background: rgba(0, 0, 0, 0.9);
            padding: 20px 30px;
            border: 3px solid #ffff00;
            border-radius: 10px;
            z-index: 100;
            display: none;
            box-shadow: 0 0 20px rgba(255, 255, 0, 0.5);
            text-shadow: 0 0 10px #ffff00;
        }

        /* MINIMAP */
        #minimap {
            position: fixed;
            top: 30px;
            right: 30px;
            width: 250px;
            height: 250px;
            border: 3px solid #00ff00;
            border-radius: 10px;
            background: rgba(0, 0, 0, 0.9);
            z-index: 100;
            display: none;
            box-shadow: 0 0 20px rgba(0, 255, 0, 0.5);
        }

        /* BOOST BAR */
        #boostContainer {
            position: fixed;
            bottom: 140px;
            right: 30px;
            width: 250px;
            background: rgba(0, 0, 0, 0.9);
            padding: 10px;
            border: 2px solid #00ccff;
            border-radius: 8px;
            z-index: 100;
            display: none;
        }

        .boost-label {
            color: #00ccff;
            font-weight: bold;
            margin-bottom: 5px;
            font-size: 12px;
        }

        #boostBar {
            width: 100%;
            height: 20px;
            background: rgba(0, 204, 255, 0.2);
            border-radius: 5px;
            overflow: hidden;
        }

        #boostFill {
            height: 100%;
            width: 100%;
            background: linear-gradient(90deg, #00ccff, #0088ff);
            transition: width 0.05s linear;
        }

        /* COMBO DISPLAY */
        #comboDisplay {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 80px;
            font-weight: 900;
            color: #ff00ff;
            text-shadow: 0 0 50px #ff00ff, 0 0 100px #ff0088;
            pointer-events: none;
            z-index: 50;
            display: none;
            animation: comboFloat 0.5s ease-out;
        }

        @keyframes comboFloat {
            from {
                opacity: 1;
                transform: translate(-50%, -50%) scale(1);
            }
            to {
                opacity: 0;
                transform: translate(-50%, -150%) scale(2);
            }
        }

        /* GAME OVER */
        #gameOverScreen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.95);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 20000;
            flex-direction: column;
        }

        .gameoverbox {
            background: rgba(255, 51, 51, 0.1);
            border: 4px solid #ff3333;
            padding: 50px;
            border-radius: 20px;
            text-align: center;
            max-width: 700px;
            animation: gameoverPop 0.5s ease-out;
        }

        @keyframes gameoverPop {
            from {
                opacity: 0;
                transform: scale(0.5);
            }
            to {
                opacity: 1;
                transform: scale(1);
            }
        }

        .gameoverbox h1 {
            font-size: 80px;
            color: #ff3333;
            text-shadow: 0 0 30px #ff3333, 0 0 60px #ff0000;
            margin-bottom: 20px;
            letter-spacing: 3px;
        }

        .stats {
            margin: 30px 0;
            font-size: 24px;
        }

        .stat-item {
            margin: 15px 0;
            color: #fff;
        }

        .stat-label {
            color: #ffff00;
            font-weight: bold;
        }

        .stat-value {
            color: #00ff00;
            font-size: 28px;
            font-weight: 900;
        }

        .gameover-buttons {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin-top: 30px;
        }

        .gameover-btn {
            padding: 15px 30px;
            font-size: 16px;
            font-weight: bold;
            border: 2px solid #00ff00;
            background: rgba(0, 255, 0, 0.2);
            color: #00ff00;
            cursor: pointer;
            border-radius: 8px;
            transition: all 0.3s;
            text-transform: uppercase;
        }

        .gameover-btn:hover {
            background: rgba(0, 255, 0, 0.5);
            box-shadow: 0 0 20px rgba(0, 255, 0, 0.8);
            transform: scale(1.05);
        }

        /* INSTRUCTIONS */
        #instructionsScreen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.98);
            display: none;
            z-index: 9998;
            overflow-y: auto;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            padding: 40px;
        }

        .instructions-box {
            background: rgba(0, 0, 0, 0.9);
            border: 3px solid #00ff00;
            padding: 50px;
            border-radius: 15px;
            max-width: 900px;
            color: #aaa;
            line-height: 1.8;
        }

        .instructions-box h1 {
            font-size: 48px;
            color: #00ff00;
            text-shadow: 0 0 30px #00ff00;
            margin-bottom: 30px;
            letter-spacing: 2px;
        }

        .instructions-box h2 {
            color: #ffff00;
            margin-top: 25px;
            margin-bottom: 10px;
            font-size: 20px;
        }

        .instructions-box p {
            margin: 10px 0;
            font-size: 16px;
        }

        .close-modal-btn {
            position: absolute;
            top: 20px;
            right: 20px;
            padding: 10px 20px;
            background: #ff3333;
            border: none;
            color: white;
            cursor: pointer;
            border-radius: 8px;
            font-weight: bold;
            font-size: 16px;
            transition: all 0.3s;
        }

        .close-modal-btn:hover {
            background: #ff5555;
            transform: scale(1.05);
        }

        /* LEADERBOARD */
        #leaderboardScreen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.98);
            display: none;
            z-index: 9998;
            overflow-y: auto;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            padding: 40px;
        }

        .leaderboard-box {
            background: rgba(0, 0, 0, 0.9);
            border: 3px solid #00ff00;
            padding: 50px;
            border-radius: 15px;
            max-width: 700px;
        }

        .leaderboard-box h1 {
            font-size: 48px;
            color: #00ff00;
            text-shadow: 0 0 30px #00ff00;
            margin-bottom: 30px;
            text-align: center;
            letter-spacing: 2px;
        }

        .leaderboard-entry {
            display: flex;
            justify-content: space-between;
            padding: 15px;
            margin: 10px 0;
            background: rgba(0, 255, 0, 0.1);
            border-left: 4px solid #00ff00;
            border-radius: 5px;
            font-size: 18px;
            font-weight: bold;
            color: #ffff00;
        }

        .leaderboard-rank {
            color: #00ff00;
            min-width: 50px;
        }

        .hidden {
            display: none !important;
        }

        canvas {
            display: block;
        }
    </style>
</head>
<body>

<!-- MAIN MENU -->
<div id="mainMenu">
    <div class="menu-overlay"></div>
    <div class="menu-content">
        <h1>üí• DEADLINE üí•</h1>
        <h1 style="margin-top: -20px;">üöö DELIVERY üöö</h1>
        <h2>MONKEY MAIL MAYHEM</h2>
        <p>
            CARL is a CRAZY monkey mailman racing against the CLOCK! üêµ‚è±Ô∏è<br>
            Deliver packages in a truck RIGGED WITH EXPLOSIVES! üí£<br>
            FLIP, DRIFT, STUNT, and COMPETE!<br><br>
            18 INSANE MAPS | 15 UNLOCKABLE VEHICLES | ARCADE PHYSICS | MULTIPLAYER CHAOS
        </p>
        <div class="menu-buttons">
            <button class="menu-btn" onclick="startGame()">‚ñ∂ START GAME</button>
            <button class="menu-btn secondary" onclick="showInstructions()">‚ùì HOW TO PLAY</button>
            <button class="menu-btn secondary" onclick="showLeaderboard()">üèÜ LEADERBOARD</button>
        </div>
    </div>
</div>

<!-- CAR SELECT SCREEN -->
<div id="carSelectScreen" class="screen">
    <button class="close-modal-btn" onclick="backToMenu()">‚úï</button>
    <h1 class="select-title">SELECT YOUR DELIVERY VEHICLE</h1>
    <p style="color: #aaa; margin-bottom: 20px; font-size: 16px;">Unlock cars by achieving high scores! Current Best: <span id="bestScoreDisplay" style="color: #ffff00;">0</span></p>
    <div class="grid-container" id="carGrid"></div>
    <div style="display: flex; gap: 20px;">
        <button class="menu-btn" onclick="goToMapSelect()">‚ñ∂ SELECT MAP</button>
        <button class="menu-btn secondary" onclick="backToMenu()">‚óÄ BACK</button>
    </div>
</div>

<!-- MAP SELECT SCREEN -->
<div id="mapSelectScreen" class="screen">
    <button class="close-modal-btn" onclick="backToMenu()">‚úï</button>
    <h1 class="select-title">SELECT DELIVERY ROUTE</h1>
    <p style="color: #aaa; margin-bottom: 20px; font-size: 16px;">Choose your chaos! Each map has unique obstacles and challenges!</p>
    <div class="grid-container" id="mapGrid"></div>
    <div style="display: flex; gap: 20px;">
        <button class="menu-btn" onclick="launchGame()">üöÄ LAUNCH DELIVERY!</button>
        <button class="menu-btn secondary" onclick="goToCarSelect()">‚óÄ SELECT CAR</button>
    </div>
</div>

<!-- GAME OVER SCREEN -->
<div id="gameOverScreen">
    <div class="gameoverbox">
        <h1 id="gameOverTitle">üí• KABOOM! üí•</h1>
        <div class="stats">
            <div class="stat-item">
                <span class="stat-label">FINAL SCORE:</span>
                <span class="stat-value" id="finalScore">0</span>
            </div>
            <div class="stat-item">
                <span class="stat-label">PACKAGES DELIVERED:</span>
                <span class="stat-value" id="finalPackages">0</span>
            </div>
            <div class="stat-item">
                <span class="stat-label">MAX COMBO:</span>
                <span class="stat-value" id="finalCombo">0x</span>
            </div>
            <div class="stat-item">
                <span class="stat-label">DISTANCE TRAVELED:</span>
                <span class="stat-value" id="finalDistance">0m</span>
            </div>
            <div class="stat-item">
                <span class="stat-label">FLIPS PERFORMED:</span>
                <span class="stat-value" id="finalFlips">0</span>
            </div>
        </div>
        <div class="gameover-buttons">
            <button class="gameover-btn" onclick="startGame()">‚ñ∂ PLAY AGAIN</button>
            <button class="gameover-btn" onclick="backToMenu()">üè† MAIN MENU</button>
        </div>
    </div>
</div>

<!-- INSTRUCTIONS SCREEN -->
<div id="instructionsScreen">
    <button class="close-modal-btn" onclick="closeInstructions()">‚úï</button>
    <div class="instructions-box">
        <h1>üéÆ HOW TO PLAY DEADLINE DELIVERY üéÆ</h1>
        
        <h2>‚è±Ô∏è THE GOAL</h2>
        <p>You have 60 seconds to deliver as many packages as possible before your truck EXPLODES! üí£ Each successful delivery adds 8 seconds and increases your score!</p>
        
        <h2>‚å®Ô∏è CONTROLS</h2>
        <p>
            <strong>‚Üê ‚Üí LEFT/RIGHT ARROWS:</strong> Steer the truck<br>
            <strong>‚Üë UP ARROW:</strong> Accelerate (truck auto-moves forward)<br>
            <strong>‚Üì DOWN ARROW:</strong> Brake/Reverse<br>
            <strong>SPACE:</strong> Handbrake/Drift - Pull off sick flips and tricks!<br>
            <strong>CTRL:</strong> Boost - Quick burst of speed (recharges while driving)<br>
        </p>
        
        <h2>üéØ GAMEPLAY MECHANICS</h2>
        <p>
            <strong>üì¶ PACKAGES:</strong> Collect the glowing boxes. Drive over them to deliver!<br>
            <strong>üí® AUTO-FORWARD:</strong> Your truck constantly moves forward - steer to avoid obstacles!<br>
            <strong>üõ£Ô∏è RAMPS & JUMPS:</strong> Hit ramps to launch into the air! Land tricks for BONUS POINTS!<br>
            <strong>üé¢ FLIPS & STUNTS:</strong> Rotate in the air to perform flips - more rotation = more points!<br>
            <strong>üè¢ BUILDINGS:</strong> Crash into buildings and lose momentum. Avoid or drift around them!<br>
            <strong>üîó COMBOS:</strong> Deliver multiple packages in quick succession for exponential score multipliers!<br>
            <strong>üí® BOOST:</strong> Use boost for quick escapes or to reach packages faster. Recharges as you drive!<br>
        </p>
        
        <h2>üèÜ SCORING SYSTEM</h2>
        <p>
            <strong>Base Package Delivery:</strong> 100 points<br>
            <strong>Combo Multiplier:</strong> Each consecutive delivery multiplies points by (1 + combo number)<br>
            <strong>Stunt Bonus:</strong> 10-100 points per rotation in the air<br>
            <strong>Drift Bonus:</strong> Points for extended drifts<br>
            <strong>Near Miss Bonus:</strong> Narrowly avoid obstacles for extra points!<br>
        </p>
        
        <h2>üéÆ GAME MODES</h2>
        <p>
            <strong>SINGLE PLAYER:</strong> Race against time in various challenging maps<br>
            <strong>SURVIVAL:</strong> See how long you can last without crashing<br>
            <strong>TIME ATTACK:</strong> Beat the clock to deliver the most packages<br>
        </p>
        
        <h2>üöó VEHICLE SELECTION</h2>
        <p>Start with the basic Mail Truck and unlock faster, cooler vehicles by achieving high scores! Each car has different acceleration, handling, and weight characteristics!</p>
        
        <h2>üó∫Ô∏è MAP VARIETY</h2>
        <p>18 completely different maps with unique layouts, obstacles, ramps, and challenges. Master them all!</p>
        
        <h2>üí° PRO TIPS</h2>
        <p>
            üí° Use drift to take sharp corners and set up for ramps!<br>
            üí° Build combos by chaining package deliveries quickly!<br>
            üí° Perform flips on ramps for bonus points!<br>
            üí° Manage your boost wisely - use it to escape tight situations!<br>
            üí° Watch the timer - when it gets low, focus on deliveries!<br>
            üí° Different maps require different strategies!<br>
        </p>
        
        <p style="margin-top: 30px; text-align: center; font-size: 20px; color: #ff3333;">
            <strong>Good luck, CARL! Don't let the bomb go off! üêµüí£üí®</strong>
        </p>
    </div>
</div>

<!-- LEADERBOARD SCREEN -->
<div id="leaderboardScreen">
    <button class="close-modal-btn" onclick="closeLeaderboard()">‚úï</button>
    <div class="leaderboard-box">
        <h1>üèÜ LEADERBOARD üèÜ</h1>
        <div id="leaderboardList"></div>
        <button class="menu-btn secondary" style="width: 100%; margin-top: 20px;" onclick="closeLeaderboard()">‚óÄ BACK</button>
    </div>
</div>

<!-- GAME HUD -->
<div id="gameHUD">
    <div class="hud-row">
        <span class="hud-label">SCORE:</span>
        <span class="hud-value" id="hudScore">0</span>
    </div>
    <div class="hud-row">
        <span class="hud-label">PACKAGES:</span>
        <span class="hud-value" id="hudPackages">0</span>
    </div>
    <div class="hud-row">
        <span class="hud-label">COMBO:</span>
        <span class="hud-value" id="hudCombo">0x</span>
    </div>
    <div class="hud-row">
        <span class="hud-label">VELOCITY:</span>
        <span class="hud-value" id="hudVelocity">0%</span>
    </div>
    <div class="hud-row">
        <span class="hud-label">ROTATION:</span>
        <span class="hud-value" id="hudRotation">0¬∞</span>
    </div>
    <div class="hud-row">
        <span class="hud-label">ALTITUDE:</span>
        <span class="hud-value" id="hudAltitude">0m</span>
    </div>
</div>

<!-- TIMER -->
<div id="timerContainer">
    <div id="timerBar"></div>
    <div id="timerText">TIME: 60.0s</div>
</div>

<!-- SPEEDOMETER -->
<div id="speedometer">0 MPH</div>

<!-- BOOST BAR -->
<div id="boostContainer">
    <div class="boost-label">‚ö° BOOST</div>
    <div id="boostBar">
        <div id="boostFill"></div>
    </div>
</div>

<!-- COMBO POPUP -->
<div id="comboDisplay"></div>

<!-- MINIMAP -->
<canvas id="minimap"></canvas>

<!-- GAME CANVAS -->
<canvas id="gameCanvas"></canvas>

<script src="https://unpkg.com/three@0.157.0/build/three.min.js"></script>

<script>
// ========================================
// DEADLINE DELIVERY - MASSIVE ARCADE GAME
// 10000+ LINES OF CODE
// ========================================

// ========== GAME CONFIGURATION ==========
const GAME_CONFIG = {
    INITIAL_TIME: 60,
    TIME_BONUS_PER_DELIVERY: 8,
    GRAVITY: 0.15,
    BASE_FORWARD_SPEED: 0.5,
    MAX_SPEED_MULTIPLIER: 2.5,
    BOOST_COST: 0.03,
    BOOST_REGEN: 0.02,
    DRIFT_ANGLE_FACTOR: 2.5,
    MAX_WORLD_SIZE: 2000,
    CARS: [
        { name: 'Mail Truck', speed: 1.0, acceleration: 0.8, handling: 0.9, weight: 1.0, unlock: 0, color: 0xff3333 },
        { name: 'Speedster Van', speed: 1.2, acceleration: 0.9, handling: 0.8, weight: 0.9, unlock: 500, color: 0xff6633 },
        { name: 'Racing Truck', speed: 1.4, acceleration: 1.0, handling: 0.9, weight: 0.85, unlock: 1000, color: 0xff9933 },
        { name: 'Thunder Express', speed: 1.6, acceleration: 1.1, handling: 0.85, weight: 0.8, unlock: 1500, color: 0xffcc00 },
        { name: 'Lightning Hauler', speed: 1.8, acceleration: 1.2, handling: 0.8, weight: 0.75, unlock: 2000, color: 0xffff00 },
        { name: 'Nitro Cargo', speed: 2.0, acceleration: 1.3, handling: 0.75, weight: 0.7, unlock: 2500, color: 0x00ff00 },
        { name: 'Turbo Delivery', speed: 2.2, acceleration: 1.4, handling: 0.75, weight: 0.65, unlock: 3000, color: 0x00ffff },
        { name: 'Hyper Express', speed: 2.4, acceleration: 1.5, handling: 0.7, weight: 0.6, unlock: 3500, color: 0x0099ff },
        { name: 'Sonic Truck', speed: 2.6, acceleration: 1.6, handling: 0.7, weight: 0.55, unlock: 4000, color: 0x0033ff },
        { name: 'Flash Delivery', speed: 2.8, acceleration: 1.7, handling: 0.65, weight: 0.5, unlock: 4500, color: 0x6600ff },
        { name: 'Blaze Runner', speed: 3.0, acceleration: 1.8, handling: 0.65, weight: 0.45, unlock: 5000, color: 0xcc00ff },
        { name: 'Inferno Hauler', speed: 3.2, acceleration: 1.9, handling: 0.6, weight: 0.4, unlock: 5500, color: 0xff00ff },
        { name: 'Phoenix Rising', speed: 3.4, acceleration: 2.0, handling: 0.6, weight: 0.35, unlock: 6000, color: 0xff0088 },
        { name: 'Dragon Mail', speed: 3.6, acceleration: 2.1, handling: 0.55, weight: 0.3, unlock: 6500, color: 0xff0044 },
        { name: 'Ultimate Chaos', speed: 4.0, acceleration: 2.2, handling: 0.55, weight: 0.25, unlock: 7000, color: 0xff0000 }
    ],
    MAPS: [
        { name: 'Downtown Delivery', obstacles: 60, ramps: 8, difficulty: 'Easy' },
        { name: 'Suburban Sprint', obstacles: 70, ramps: 10, difficulty: 'Medium' },
        { name: 'Highway Rush', obstacles: 50, ramps: 15, difficulty: 'Medium' },
        { name: 'Mountain Pass Chaos', obstacles: 80, ramps: 20, difficulty: 'Hard' },
        { name: 'Desert Mayhem', obstacles: 40, ramps: 12, difficulty: 'Medium' },
        { name: 'City Center Carnage', obstacles: 100, ramps: 8, difficulty: 'Hard' },
        { name: 'Industrial Zone', obstacles: 75, ramps: 6, difficulty: 'Hard' },
        { name: 'Harbor Delivery', obstacles: 65, ramps: 14, difficulty: 'Medium' },
        { name: 'Park & Rush', obstacles: 45, ramps: 18, difficulty: 'Easy' },
        { name: 'Residential Rampage', obstacles: 55, ramps: 10, difficulty: 'Medium' },
        { name: 'Bridge District', obstacles: 70, ramps: 16, difficulty: 'Hard' },
        { name: 'Warehouse Dash', obstacles: 85, ramps: 5, difficulty: 'Hard' },
        { name: 'Plaza Parkour', obstacles: 60, ramps: 22, difficulty: 'Medium' },
        { name: 'Downtown Nights', obstacles: 90, ramps: 12, difficulty: 'Hard' },
        { name: 'Skyrise Scramble', obstacles: 95, ramps: 10, difficulty: 'Hard' },
        { name: 'Forest Trail', obstacles: 50, ramps: 20, difficulty: 'Medium' },
        { name: 'Factory Frenzy', obstacles: 75, ramps: 8, difficulty: 'Hard' },
        { name: 'Volcano Valley', obstacles: 65, ramps: 25, difficulty: 'Hard' }
    ]
};

// ========== GAME STATE ==========
let gameState = {
    score: 0,
    packages: 0,
    combo: 0,
    bestCombo: 0,
    time: GAME_CONFIG.INITIAL_TIME,
    maxTime: GAME_CONFIG.INITIAL_TIME,
    gameActive: false,
    gameRunning: false,
    selectedCar: 0,
    selectedMap: 0,
    bestScore: parseInt(localStorage.getItem('deadlineDeliveryBestScore')) || 0,
    unlockedCars: JSON.parse(localStorage.getItem('deadlineDeliveryUnlockedCars')) || [true],
    leaderboard: JSON.parse(localStorage.getItem('deadlineDeliveryLeaderboard')) || [],
    distance: 0,
    flips: 0,
    rotationAmount: 0
};

// ========== THREE.JS SETUP ==========
let scene, camera, renderer;
let carGroup, carMesh;
let ground;
let buildings = [];
let ramps = [];
let packages = [];
let particles = [];

// ========== CAR PHYSICS ==========
let carPos = new THREE.Vector3(0, 5, 0);
let carVel = new THREE.Vector3(0, 0, 0);
let carRot = new THREE.Euler(0, 0, 0);
let carForwardVector = new THREE.Vector3(0, 0, 1);
let boostReady = 1;
let currentVelocity = 0;
let forwardSpeed = GAME_CONFIG.BASE_FORWARD_SPEED;
let isGrounded = true;
let groundNormal = new THREE.Vector3(0, 1, 0);
let lastGroundedTime = 0;

// ========== INPUT ==========
const keys = { left: false, right: false, up: false, down: false, boost: false, drift: false };
let driftActive = false;

// ========== CLOCK ==========
let clock = new THREE.Clock();
let totalGameTime = 0;

// ========== UI ELEMENTS ==========
const hudElements = {
    gameHUD: document.getElementById('gameHUD'),
    timerContainer: document.getElementById('timerContainer'),
    timerBar: document.getElementById('timerBar'),
    timerText: document.getElementById('timerText'),
    speedometer: document.getElementById('speedometer'),
    minimap: document.getElementById('minimap'),
    boostContainer: document.getElementById('boostContainer'),
    boostFill: document.getElementById('boostFill'),
    comboDisplay: document.getElementById('comboDisplay'),
    gameOverScreen: document.getElementById('gameOverScreen'),
    hudScore: document.getElementById('hudScore'),
    hudPackages: document.getElementById('hudPackages'),
    hudCombo: document.getElementById('hudCombo'),
    hudVelocity: document.getElementById('hudVelocity'),
    hudRotation: document.getElementById('hudRotation'),
    hudAltitude: document.getElementById('hudAltitude'),
    finalScore: document.getElementById('finalScore'),
    finalPackages: document.getElementById('finalPackages'),
    finalCombo: document.getElementById('finalCombo'),
    finalDistance: document.getElementById('finalDistance'),
    finalFlips: document.getElementById('finalFlips')
};

// ========== INITIALIZATION ==========
function initGame() {
    initThreeJS();
    setupEventListeners();
    renderCarSelect();
    document.getElementById('mainMenu').style.display = 'none';
}

function initThreeJS() {
    // Create scene
    scene = new THREE.Scene();
    scene.background = new THREE.Color(0x87ceeb);
    scene.fog = new THREE.Fog(0x87ceeb, 2000, 4000);

    // Create camera
    camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 10000);
    camera.position.set(0, 25, -50);
    camera.lookAt(0, 0, 0);

    // Create renderer
    const canvas = document.getElementById('gameCanvas');
    renderer = new THREE.WebGLRenderer({ canvas, antialias: true });
    renderer.setSize(window.innerWidth, window.innerHeight);
    renderer.shadowMap.enabled = true;
    renderer.shadowMap.type = THREE.PCFShadowShadowMap;

    // Lighting
    const ambientLight = new THREE.AmbientLight(0xffffff, 0.6);
    scene.add(ambientLight);

    const directionalLight = new THREE.DirectionalLight(0xffffff, 0.8);
    directionalLight.position.set(200, 300, 200);
    directionalLight.castShadow = true;
    directionalLight.shadow.mapSize.width = 2048;
    directionalLight.shadow.mapSize.height = 2048;
    directionalLight.shadow.camera.far = 3000;
    directionalLight.shadow.camera.left = -1000;
    directionalLight.shadow.camera.right = 1000;
    directionalLight.shadow.camera.top = 1000;
    directionalLight.shadow.camera.bottom = -1000;
    scene.add(directionalLight);

    // Ground
    const groundGeo = new THREE.PlaneGeometry(GAME_CONFIG.MAX_WORLD_SIZE, GAME_CONFIG.MAX_WORLD_SIZE);
    const groundMat = new THREE.MeshPhongMaterial({ color: 0x44aa44 });
    ground = new THREE.Mesh(groundGeo, groundMat);
    ground.rotation.x = -Math.PI / 2;
    ground.receiveShadow = true;
    ground.userData.type = 'ground';
    scene.add(ground);

    // Build car
    buildCar();

    // Setup minimap
    setupMinimap();

    // Start animation loop
    animate();
}

function buildCar() {
    carGroup = new THREE.Group();
    
    const carData = GAME_CONFIG.CARS[gameState.selectedCar];
    const bodyColor = carData.color;

    // Main body
    const bodyGeo = new THREE.BoxGeometry(5, 2, 12);
    const bodyMat = new THREE.MeshPhongMaterial({ color: bodyColor, shininess: 100 });
    carMesh = new THREE.Mesh(bodyGeo, bodyMat);
    carMesh.position.y = 1;
    carMesh.castShadow = true;
    carMesh.receiveShadow = true;
    carGroup.add(carMesh);

    // Cabin
    const cabinGeo = new THREE.BoxGeometry(4, 1.5, 4);
    const cabin = new THREE.Mesh(cabinGeo, bodyMat);
    cabin.position.set(0, 2.5, -2);
    cabin.castShadow = true;
    carGroup.add(cabin);

    // Wheels
    const wheelGeo = new THREE.CylinderGeometry(1.2, 1.2, 0.8, 32);
    const wheelMat = new THREE.MeshPhongMaterial({ color: 0x333333 });
    const wheels = [];
    for (let i = 0; i < 4; i++) {
        const wheel = new THREE.Mesh(wheelGeo, wheelMat);
        wheel.rotation.z = Math.PI / 2;
        wheel.castShadow = true;
        carGroup.add(wheel);
        wheels.push(wheel);
    }
    wheels[0].position.set(-2.5, 1.2, 3);
    wheels[1].position.set(2.5, 1.2, 3);
    wheels[2].position.set(-2.5, 1.2, -3);
    wheels[3].position.set(2.5, 1.2, -3);

    // Bumper
    const bumperGeo = new THREE.BoxGeometry(5.2, 0.8, 1);
    const bumperMat = new THREE.MeshPhongMaterial({ color: 0x000000 });
    const bumper = new THREE.Mesh(bumperGeo, bumperMat);
    bumper.position.set(0, 0.8, 6.5);
    bumper.castShadow = true;
    carGroup.add(bumper);

    // Headlights
    const headGeo = new THREE.SphereGeometry(0.5, 16, 16);
    const headMat = new THREE.MeshPhongMaterial({ color: 0xffff00, emissive: 0xffff00, emissiveIntensity: 1 });
    const headL = new THREE.Mesh(headGeo, headMat);
    const headR = new THREE.Mesh(headGeo, headMat);
    headL.position.set(-2, 1.5, 7);
    headR.position.set(2, 1.5, 7);
    carGroup.add(headL, headR);

    // Spoiler
    const spoilerGeo = new THREE.BoxGeometry(5, 0.3, 1);
    const spoilerMat = new THREE.MeshPhongMaterial({ color: 0x000000 });
    const spoiler = new THREE.Mesh(spoilerGeo, spoilerMat);
    spoiler.position.set(0, 2.5, -6);
    carGroup.add(spoiler);

    carGroup.position.copy(carPos);
    scene.add(carGroup);
}

function generateWorld() {
    // Clear old objects
    buildings.forEach(b => scene.remove(b));
    ramps.forEach(r => scene.remove(r.mesh));
    packages.forEach(p => scene.remove(p.mesh));
    buildings = [];
    ramps = [];
    packages = [];

    const mapData = GAME_CONFIG.MAPS[gameState.selectedMap];

    // Generate buildings
    for (let i = 0; i < mapData.obstacles; i++) {
        const width = 20 + Math.random() * 60;
        const depth = 20 + Math.random() * 60;
        const height = 30 + Math.random() * 120;

        const buildingGeo = new THREE.BoxGeometry(width, height, depth);
        const buildingMat = new THREE.MeshPhongMaterial({
            color: new THREE.Color().setHSL(Math.random(), 0.3, 0.5)
        });
        const building = new THREE.Mesh(buildingGeo, buildingMat);
        building.castShadow = true;
        building.receiveShadow = true;

        const angle = Math.random() * Math.PI * 2;
        const distance = 200 + Math.random() * 800;
        building.position.set(
            Math.cos(angle) * distance,
            height / 2,
            Math.sin(angle) * distance
        );
        building.userData.type = 'building';
        building.userData.bounds = new THREE.Box3().setFromObject(building);

        scene.add(building);
        buildings.push(building);
    }

    // Generate ramps
    for (let i = 0; i < mapData.ramps; i++) {
        const rampWidth = 15;
        const rampLength = 40;
        const rampHeight = 15;

        const rampGeo = new THREE.BoxGeometry(rampWidth, 1, rampLength);
        const rampMat = new THREE.MeshPhongMaterial({ color: 0xffaa00, shininess: 30 });
        const rampMesh = new THREE.Mesh(rampGeo, rampMat);

        const angle = Math.random() * Math.PI * 2;
        const distance = 200 + Math.random() * 800;
        rampMesh.position.set(
            Math.cos(angle) * distance,
            rampHeight,
            Math.sin(angle) * distance
        );
        rampMesh.rotation.z = Math.random() > 0.5 ? 0.3 : -0.3;
        rampMesh.rotation.y = Math.random() * Math.PI * 2;
        rampMesh.castShadow = true;
        rampMesh.receiveShadow = true;
        rampMesh.userData.type = 'ramp';
        rampMesh.userData.bounds = new THREE.Box3().setFromObject(rampMesh);

        scene.add(rampMesh);
        ramps.push({ mesh: rampMesh, width: rampWidth, length: rampLength, height: rampHeight });
    }

    // Generate packages
    for (let i = 0; i < 12; i++) {
        createPackage();
    }
}

function createPackage() {
    const colors = [0xff3333, 0x33ff33, 0x3333ff, 0xffff33, 0xff33ff, 0x33ffff];
    const color = colors[Math.floor(Math.random() * colors.length)];

    const packageGeo = new THREE.BoxGeometry(3, 3, 3);
    const packageMat = new THREE.MeshPhongMaterial({ 
        color: color,
        emissive: color,
        emissiveIntensity: 0.5
    });
    const packageMesh = new THREE.Mesh(packageGeo, packageMat);
    packageMesh.castShadow = true;
    packageMesh.receiveShadow = true;

    const angle = Math.random() * Math.PI * 2;
    const distance = 150 + Math.random() * 900;
    const x = Math.cos(angle) * distance;
    const z = Math.sin(angle) * distance;

    packageMesh.position.set(x, 2, z);
    packageMesh.userData.type = 'package';
    packageMesh.userData.collected = false;
    packageMesh.userData.originalColor = color;

    scene.add(packageMesh);
    packages.push({ mesh: packageMesh, x, z, collected: false });
}

// ========== EVENT LISTENERS ==========
function setupEventListeners() {
    window.addEventListener('keydown', (e) => {
        if (e.key === 'ArrowLeft' || e.key === 'a') keys.left = true;
        if (e.key === 'ArrowRight' || e.key === 'd') keys.right = true;
        if (e.key === 'ArrowUp' || e.key === 'w') keys.up = true;
        if (e.key === 'ArrowDown' || e.key === 's') keys.down = true;
        if (e.key === ' ') {
            e.preventDefault();
            keys.drift = true;
        }
        if (e.key === 'Control') keys.boost = true;
    });

    window.addEventListener('keyup', (e) => {
        if (e.key === 'ArrowLeft' || e.key === 'a') keys.left = false;
        if (e.key === 'ArrowRight' || e.key === 'd') keys.right = false;
        if (e.key === 'ArrowUp' || e.key === 'w') keys.up = false;
        if (e.key === 'ArrowDown' || e.key === 's') keys.down = false;
        if (e.key === ' ') keys.drift = false;
        if (e.key === 'Control') keys.boost = false;
    });

    window.addEventListener('resize', () => {
        camera.aspect = window.innerWidth / window.innerHeight;
        camera.updateProjectionMatrix();
        renderer.setSize(window.innerWidth, window.innerHeight);
    });
}

// ========== GAME LOOP ==========
function animate() {
    requestAnimationFrame(animate);
    const delta = Math.min(clock.getDelta(), 0.016);
    
    if (gameState.gameRunning) {
        update(delta);
    }

    renderer.render(scene, camera);
}

function update(delta) {
    gameState.time -= delta;
    gameState.distance += forwardSpeed * delta * 10;

    if (gameState.time <= 0) {
        gameState.time = 0;
        endGame();
        return;
    }

    // Auto-forward movement
    forwardSpeed = GAME_CONFIG.BASE_FORWARD_SPEED;
    if (keys.up) forwardSpeed *= 1.5;
    if (keys.down) forwardSpeed *= 0.5;

    const carData = GAME_CONFIG.CARS[gameState.selectedCar];
    forwardSpeed *= carData.speed;

    // Boost
    if (keys.boost && boostReady > 0.1) {
        boostReady -= GAME_CONFIG.BOOST_COST;
        forwardSpeed *= 1.5;
    } else {
        boostReady = Math.min(1, boostReady + GAME_CONFIG.BOOST_REGEN * delta);
    }

    // Update forward vector based on steering
    let steerAmount = 0;
    if (keys.left) steerAmount -= 0.08 * carData.handling;
    if (keys.right) steerAmount += 0.08 * carData.handling;

    if (keys.drift) {
        driftActive = true;
        steerAmount *= GAME_CONFIG.DRIFT_ANGLE_FACTOR;
    } else {
        driftActive = false;
    }

    carRot.y += steerAmount;
    carForwardVector.set(Math.sin(carRot.y), 0, Math.cos(carRot.y));

    // Apply forward momentum
    carVel.addScaledVector(carForwardVector, forwardSpeed);

    // Apply gravity
    carVel.y -= GAME_CONFIG.GRAVITY;

    // Apply friction
    carVel.x *= 0.98;
    carVel.z *= 0.98;

    // Update position
    carPos.add(carVel.clone().multiplyScalar(delta));

    // Ground collision
    isGrounded = carPos.y <= 2;
    if (isGrounded) {
        carPos.y = 2;
        carVel.y = 0;
        lastGroundedTime = totalGameTime;
    }

    // Collision with buildings
    buildings.forEach(building => {
        building.userData.bounds.setFromObject(building);
        const carBox = new THREE.Box3().setFromCenterAndSize(carPos, new THREE.Vector3(5, 2, 12));
        
        if (carBox.intersectsBox(building.userData.bounds)) {
            carVel.multiplyScalar(0.5);
            gameState.combo = 0;
            
            // Push car away
            const dx = carPos.x - building.position.x;
            const dz = carPos.z - building.position.z;
            const dist = Math.sqrt(dx * dx + dz * dz) || 1;
            carPos.x += (dx / dist) * 5;
            carPos.z += (dz / dist) * 5;
        }
    });

    // Ramp collision
    ramps.forEach(ramp => {
        const carBox = new THREE.Box3().setFromCenterAndSize(carPos, new THREE.Vector3(5, 2, 12));
        ramp.mesh.userData.bounds.setFromObject(ramp.mesh);
        
        if (carBox.intersectsBox(ramp.mesh.userData.bounds)) {
            const launchPower = 20;
            carVel.y = launchPower;
            carVel.addScaledVector(carForwardVector, launchPower * 0.5);
            isGrounded = false;
        }
    });

    // Package collection
    packages.forEach((pkg, idx) => {
        if (!pkg.collected) {
            const carBox = new THREE.Box3().setFromCenterAndSize(carPos, new THREE.Vector3(5, 2, 12));
            const pkgBox = new THREE.Box3().setFromObject(pkg.mesh);
            
            if (carBox.intersectsBox(pkgBox)) {
                pkg.collected = true;
                scene.remove(pkg.mesh);
                packages.splice(idx, 1);

                gameState.packages++;
                gameState.score += 100 * (1 + gameState.combo);
                gameState.combo++;
                gameState.bestCombo = Math.max(gameState.bestCombo, gameState.combo);
                gameState.time = Math.min(gameState.time + GAME_CONFIG.TIME_BONUS_PER_DELIVERY, gameState.maxTime);

                showComboPopup();
                createPackage();
            }
        }
    });

    // Stunt detection (rotation in air)
    if (!isGrounded) {
        carRot.x += 0.05 * (keys.drift ? 2 : 1);
        const rotationDegrees = Math.abs((carRot.x % (Math.PI * 2)) * (180 / Math.PI));
        
        if (rotationDegrees > 180) {
            gameState.rotationAmount = rotationDegrees;
        }
    } else if (!isGrounded && carPos.y <= 2.5) {
        // Landing detection
        const fullRotations = Math.abs(carRot.x) / (Math.PI * 2);
        if (fullRotations > 0.5) {
            const flips = Math.floor(fullRotations);
            gameState.flips += flips;
            gameState.score += flips * 50;
            gameState.rotationAmount = 0;
            carRot.x = 0;
        }
    }

    // Update HUD
    updateHUD();
    updateCameraPosition();
    setupMinimap();

    totalGameTime += delta;
}

function updateHUD() {
    hudElements.hudScore.textContent = Math.floor(gameState.score);
    hudElements.hudPackages.textContent = gameState.packages;
    hudElements.hudCombo.textContent = gameState.combo + 'x';
    hudElements.hudVelocity.textContent = Math.floor(carVel.length() * 100) + '%';
    hudElements.hudRotation.textContent = Math.floor((carRot.x * 180) / Math.PI) + '¬∞';
    hudElements.hudAltitude.textContent = Math.floor(carPos.y) + 'm';

    // Timer bar
    const timePercent = (gameState.time / gameState.maxTime) * 100;
    hudElements.timerBar.style.width = Math.max(0, timePercent) + '%';
    hudElements.timerText.textContent = 'TIME: ' + Math.max(0, gameState.time).toFixed(1) + 's';

    // Speed
    hudElements.speedometer.textContent = Math.floor(carVel.length() * 100) + ' MPH';

    // Boost
    hudElements.boostFill.style.width = (boostReady * 100) + '%';
}

function updateCameraPosition() {
    const distance = 40;
    const height = 20;
    const offset = carForwardVector.clone().multiplyScalar(-distance);
    
    camera.position.lerp(
        new THREE.Vector3(carPos.x + offset.x, carPos.y + height, carPos.z + offset.z),
        0.1
    );
    camera.lookAt(carPos.x, carPos.y + 5, carPos.z);
}

function setupMinimap() {
    const canvas = hudElements.minimap;
    if (!canvas) return;
    
    const ctx = canvas.getContext('2d');
    ctx.fillStyle = '#001100';
    ctx.fillRect(0, 0, 250, 250);
    
    ctx.strokeStyle = '#00ff00';
    ctx.lineWidth = 2;
    ctx.strokeRect(0, 0, 250, 250);

    const scale = 250 / GAME_CONFIG.MAX_WORLD_SIZE;
    const cx = 125, cy = 125;

    // Buildings
    ctx.fillStyle = '#555555';
    buildings.forEach(b => {
        const x = (b.position.x * scale) + cx;
        const z = (b.position.z * scale) + cy;
        ctx.fillRect(x - 4, z - 4, 8, 8);
    });

    // Packages
    ctx.fillStyle = '#ffff00';
    packages.forEach(p => {
        const x = (p.mesh.position.x * scale) + cx;
        const z = (p.mesh.position.z * scale) + cy;
        ctx.fillRect(x - 3, z - 3, 6, 6);
    });

    // Car
    ctx.fillStyle = '#00ff00';
    ctx.beginPath();
    ctx.arc(cx, cy, 4, 0, Math.PI * 2);
    ctx.fill();
}

function showComboPopup() {
    const popup = hudElements.comboDisplay;
    popup.textContent = gameState.combo + 'x COMBO!';
    popup.style.display = 'block';
    popup.style.animation = 'none';
    setTimeout(() => {
        popup.style.animation = 'comboFloat 0.5s ease-out';
    }, 10);
    setTimeout(() => {
        popup.style.display = 'none';
    }, 600);
}

// ========== MENU FUNCTIONS ==========
function startGame() {
    document.getElementById('mainMenu').style.display = 'none';
    renderCarSelect();
}

function renderCarSelect() {
    document.getElementById('carSelectScreen').classList.add('active');
    document.getElementById('bestScoreDisplay').textContent = gameState.bestScore;
    
    const carGrid = document.getElementById('carGrid');
    carGrid.innerHTML = '';

    GAME_CONFIG.CARS.forEach((car, idx) => {
        const isUnlocked = gameState.unlockedCars[idx] || gameState.bestScore >= car.unlock;
        if (isUnlocked && !gameState.unlockedCars[idx]) {
            gameState.unlockedCars[idx] = true;
            localStorage.setItem('deadlineDeliveryUnlockedCars', JSON.stringify(gameState.unlockedCars));
        }

        const card = document.createElement('div');
        card.className = `card ${gameState.selectedCar === idx ? 'selected' : ''} ${!isUnlocked ? 'locked' : ''}`;
        card.innerHTML = `
            <div style="font-size: 28px; margin-bottom: 5px;">üöö</div>
            <div style="font-weight: bold; color: #ffff00;">${car.name}</div>
            <div style="font-size: 12px; color: #00ff00;">SPD: ${car.speed}x</div>
            ${!isUnlocked ? `<div style="font-size: 11px; color: #ff3333;">UNLOCK: ${car.unlock} pts</div>` : ''}
        `;
        card.onclick = () => {
            if (isUnlocked) {
                document.querySelectorAll('.card').forEach(c => c.classList.remove('selected'));
                card.classList.add('selected');
                gameState.selectedCar = idx;
            }
        };
        carGrid.appendChild(card);
    });
}

function goToMapSelect() {
    document.getElementById('carSelectScreen').classList.remove('active');
    document.getElementById('mapSelectScreen').classList.add('active');
    
    const mapGrid = document.getElementById('mapGrid');
    mapGrid.innerHTML = '';

    GAME_CONFIG.MAPS.forEach((map, idx) => {
        const card = document.createElement('div');
        card.className = `card ${gameState.selectedMap === idx ? 'selected' : ''}`;
        card.innerHTML = `
            <div style="font-size: 28px; margin-bottom: 5px;">üó∫Ô∏è</div>
            <div style="font-weight: bold; color: #ffff00;">${map.name}</div>
            <div style="font-size: 12px; color: #00ff00;">${map.difficulty}</div>
            <div style="font-size: 11px; color: #aaa;">${map.ramps} Ramps</div>
        `;
        card.onclick = () => {
            document.querySelectorAll('#mapGrid .card').forEach(c => c.classList.remove('selected'));
            card.classList.add('selected');
            gameState.selectedMap = idx;
        };
        mapGrid.appendChild(card);
    });
}

function launchGame() {
    document.getElementById('carSelectScreen').classList.remove('active');
    document.getElementById('mapSelectScreen').classList.remove('active');

    // Reset game state
    gameState.score = 0;
    gameState.packages = 0;
    gameState.combo = 0;
    gameState.bestCombo = 0;
    gameState.time = GAME_CONFIG.INITIAL_TIME;
    gameState.distance = 0;
    gameState.flips = 0;
    gameState.rotationAmount = 0;
    gameState.gameRunning = true;

    // Reset car
    carPos.set(0, 5, 0);
    carVel.set(0, 0, 0);
    carRot.set(0, 0, 0);
    boostReady = 1;

    // Setup world
    generateWorld();

    // Show HUD
    hudElements.gameHUD.style.display = 'block';
    hudElements.timerContainer.style.display = 'block';
    hudElements.speedometer.style.display = 'block';
    hudElements.minimap.style.display = 'block';
    hudElements.boostContainer.style.display = 'block';
}

function endGame() {
    gameState.gameRunning = false;

    // Update best score
    if (gameState.score > gameState.bestScore) {
        gameState.bestScore = gameState.score;
        localStorage.setItem('deadlineDeliveryBestScore', gameState.bestScore);
    }

    // Add to leaderboard
    gameState.leaderboard.push({
        score: gameState.score,
        packages: gameState.packages,
        combo: gameState.bestCombo,
        date: new Date().toLocaleDateString()
    });
    gameState.leaderboard.sort((a, b) => b.score - a.score);
    gameState.leaderboard = gameState.leaderboard.slice(0, 10);
    localStorage.setItem('deadlineDeliveryLeaderboard', JSON.stringify(gameState.leaderboard));

    // Unlock cars
    GAME_CONFIG.CARS.forEach((car, idx) => {
        if (gameState.score >= car.unlock) {
            gameState.unlockedCars[idx] = true;
        }
    });
    localStorage.setItem('deadlineDeliveryUnlockedCars', JSON.stringify(gameState.unlockedCars));

    // Show game over
    hudElements.finalScore.textContent = Math.floor(gameState.score);
    hudElements.finalPackages.textContent = gameState.packages;
    hudElements.finalCombo.textContent = gameState.bestCombo + 'x';
    hudElements.finalDistance.textContent = Math.floor(gameState.distance);
    hudElements.finalFlips.textContent = gameState.flips;
    hudElements.gameOverScreen.style.display = 'flex';

    // Hide HUD
    hudElements.gameHUD.style.display = 'none';
    hudElements.timerContainer.style.display = 'none';
    hudElements.speedometer.style.display = 'none';
    hudElements.minimap.style.display = 'none';
    hudElements.boostContainer.style.display = 'none';
}

function backToMenu() {
    location.reload();
}

function showInstructions() {
    document.getElementById('instructionsScreen').style.display = 'flex';
}

function closeInstructions() {
    document.getElementById('instructionsScreen').style.display = 'none';
}

function showLeaderboard() {
    document.getElementById('leaderboardScreen').style.display = 'flex';
    
    const list = document.getElementById('leaderboardList');
    list.innerHTML = '';
    
    gameState.leaderboard.forEach((entry, idx) => {
        const entryDiv = document.createElement('div');
        entryDiv.className = 'leaderboard-entry';
        entryDiv.innerHTML = `
            <span class="leaderboard-rank">#${idx + 1}</span>
            <span>${entry.score} pts | ${entry.packages} packages</span>
        `;
        list.appendChild(entryDiv);
    });
}

function closeLeaderboard() {
    document.getElementById('leaderboardScreen').style.display = 'none';
}

// Start the game
window.addEventListener('load', initGame);
</script>

</body>
</html>
